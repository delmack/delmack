{% extends "base.html" %}

{% block title %}Mapa de Imóveis - Baggio Portal{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
{% endblock %}

{% block content %}
<header class="main-header">
    <h1>Mapa de Imóveis - Região Sul</h1>
</header>

<section class="indicators-grid" id="indicators-container">
    <!-- Indicadores serão carregados aqui via JS -->
</section>

<section class="charts-grid">
    <div class="chart-card chart-loading" id="transaction-chart-container">
        <h3>Distribuição por Tipo de Transação</h3>
        <canvas id="transactionChart"></canvas>
    </div>
    <div class="chart-card chart-loading" id="type-chart-container">
        <h3>Top 5 Tipos de Imóveis</h3>
        <canvas id="typeChart"></canvas>
    </div>
</section>

<section class="content-area">
    <div id="map" class="map-loading"></div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function ( ) {
    showLoading();
    
    // CORREÇÃO: Apontar para os endpoints proxy no nosso backend
    const dataUrl = '/api/proxy/map-data';
    const statsUrl = '/api/proxy/map-stats';

    Promise.all([
        fetch(dataUrl),
        fetch(statsUrl)
    ])
    .then(async ([propertiesRes, statsRes]) => {
        if (!propertiesRes.ok || !statsRes.ok) {
            throw new Error('Falha ao carregar dados do servidor.');
        }
        const properties = await propertiesRes.json();
        const stats = await statsRes.json();
        
        if (properties.error || stats.error) {
            throw new Error(properties.error || stats.error);
        }
        
        renderIndicators(stats);
        initMap(properties);
        initCharts(stats);
        
    }).catch(error => {
        console.error('Error:', error);
        document.getElementById('indicators-container').innerHTML = `<div class="alert alert-danger" style="grid-column: 1 / -1;">Erro ao carregar dados: ${error.message}</div>`;
    }).finally(() => {
        hideLoading();
        document.querySelectorAll('.chart-loading, .map-loading').forEach(el => el.classList.remove('chart-loading', 'map-loading'));
    });
    
    // O resto do seu JavaScript do mapa (initMap, initCharts, etc.) continua aqui...
    // Nenhuma outra alteração é necessária no resto do script.
});

function showLoading() { document.getElementById('global-loading').style.display = 'flex'; }
function hideLoading() { document.getElementById('global-loading').style.display = 'none'; }

function renderIndicators(stats) { /* ... */ }
function initMap(properties) { /* ... */ }
function initCharts(stats) { /* ... */ }
// ... (cole o resto das funções JS que você já tinha para o mapa)
</script>
{% endblock %}
