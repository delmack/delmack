<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Imóveis - Baggio Portal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <!-- CSS do Leaflet (biblioteca do mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- CSS do MarkerCluster para agrupamento -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- INÍCIO DA BARRA LATERAL (SIDEBAR ) CORRIGIDA -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="{{ url_for('static', filename='baggio-logo.png') }}" alt="Logo Baggio" class="sidebar-logo">
                <h3>BAGGIO PORTAL</h3>
            </div>
            <nav class="sidebar-nav">
                <a href="{{ url_for('admin_portal') }}" class="nav-item">PAINEL</a>
                <a href="{{ url_for('pagina_menu', pagina='usuarios') }}" class="nav-item">USUÁRIOS</a>
                <a href="{{ url_for('pagina_menu', pagina='imoveis') }}" class="nav-item">IMÓVEIS</a>
                <a href="{{ url_for('mapa') }}" class="nav-item active">MAPA</a> <!-- Marca como ativo -->
                <a href="{{ url_for('pagina_menu', pagina='contratos') }}" class="nav-item">CONTRATOS</a>
                <a href="{{ url_for('pagina_menu', pagina='manutencao') }}" class="nav-item">MANUTENÇÃO</a>
                <a href="{{ url_for('pagina_menu', pagina='pessoas') }}" class="nav-item">PESSOAS</a>
                <a href="{{ url_for('pagina_menu', pagina='financeiro') }}" class="nav-item">FINANCEIRO</a>
                <a href="{{ url_for('pagina_menu', pagina='imobiliaria') }}" class="nav-item">IMOBILIÁRIA</a>
                <a href="{{ url_for('pagina_menu', pagina='crm') }}" class="nav-item">CRM</a>
                {% if session.get('role') == 'ti_admin' %}
                <a href="{{ url_for('ti_kanban') }}" class="nav-item nav-item-ti">TI</a>
                {% endif %}
                <a href="{{ url_for('chamado_ti') }}" class="nav-item nav-item-ti">CHAMADO TI</a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <span class="username">Utilizador: {{ session.get('username') }}</span>
                    <a href="{{ url_for('logout') }}" class="logout-link">Sair</a>
                </div>
            </div>
        </aside>
        <!-- FIM DA BARRA LATERAL (SIDEBAR) -->

        <main class="main-content">
            <header class="main-header">
                <h1>Mapa de Imóveis - Região Sul</h1>
            </header>
            
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
              {% endif %}
            {% endwith %}

            <!-- Indicadores da API -->
            {% if api_stats.error %}
            <div class="alert alert-danger">
                <strong>Erro na API:</strong> {{ api_stats.error }}
            </div>
            {% else %}
            <section class="indicators-grid">
                <div class="indicator-card">
                    <h3>Total de Imóveis</h3>
                    <p class="indicator-value">{{ api_stats.total_properties }}</p>
                </div>
                <div class="indicator-card">
                    <h3>Para Venda</h3>
                    <p class="indicator-value">{{ api_stats.by_transaction.get('SALE', 0) }}</p>
                </div>
                <div class="indicator-card">
                    <h3>Para Aluguel</h3>
                    <p class="indicator-value">{{ api_stats.by_transaction.get('RENT', 0) }}</p>
                </div>
                <div class="indicator-card">
                    <h3>Tipos Diferentes</h3>
                    <p class="indicator-value">{{ api_stats.by_type|length }}</p>
                </div>
            </section>

            <!-- Gráficos -->
            <section class="charts-grid">
                <div class="chart-card">
                    <h3>Distribuição por Tipo de Transação</h3>
                    <canvas id="transactionChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Top 5 Tipos de Imóveis</h3>
                    <canvas id="typeChart"></canvas>
                </div>
            </section>

            <!-- Filtros -->
            <section class="filters-section">
                <h3>Filtros do Mapa</h3>
                <div class="filters-container">
                    <div class="filter-group">
                        <label for="transactionFilter">Tipo de Transação:</label>
                        <select id="transactionFilter">
                            <option value="">Todos</option>
                            <option value="SALE">Venda</option>
                            <option value="RENT">Aluguel</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="typeFilter">Tipo de Imóvel:</label>
                        <select id="typeFilter">
                            <option value="">Todos</option>
                            {% for type_name in api_stats.by_type.keys() %}
                            <option value="{{ type_name }}">{{ type_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button id="applyFilters" class="btn-apply-filters">Aplicar Filtros</button>
                    <button id="clearFilters" class="btn-clear-filters">Limpar Filtros</button>
                </div>
            </section>
            {% endif %}

            <section class="content-area">
                <!-- O DIV do mapa -->
                <div id="map"></div>
            </section>
        </main>
    </div>

    <!-- JS do Leaflet, MarkerCluster e o nosso script do mapa DEVEM VIR NO FINAL -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Dados dos imóveis passados do Flask
            const properties = {{ properties|tojson }};
            const apiStats = {{ api_stats|tojson }};

            // Inicializa o mapa centrado na região Sul
            var map = L.map('map').setView([-27.5, -51.5], 7);

            // Adiciona a camada de "tiles" do OpenStreetMap ao mapa
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // Grupo de marcadores com clustering
            var markers = L.markerClusterGroup({
                chunkedLoading: true,
                maxClusterRadius: 50
            });

            // Array para armazenar todos os marcadores
            var allMarkers = [];

            // Função para criar ícones personalizados baseados no tipo de transação
            function createCustomIcon(transactionType) {
                const color = transactionType === 'SALE' ? '#28a745' : '#007bff';
                return L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
            }

            // Função para formatar valores monetários
            function formatCurrency(value) {
                if (!value) return 'N/A';
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            }

            // Adicionar marcadores para cada imóvel
            properties.forEach(function(property) {
                const lat = parseFloat(property.dcmAddressLatitude);
                const lng = parseFloat(property.dcmAddressLongitude);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    const icon = createCustomIcon(property.chrTransactionType);
                    
                    // Determinar o valor a exibir
                    let valueText = 'Valor não informado';
                    if (property.chrTransactionType === 'SALE' && property.dcmSale) {
                        valueText = formatCurrency(property.dcmSale);
                    } else if (property.chrTransactionType === 'RENT' && property.dcmExpectedRent) {
                        valueText = formatCurrency(property.dcmExpectedRent);
                    }

                    const popupContent = `
                        <div class="property-popup">
                            <h4>${property.chrCondoName || 'Nome não informado'}</h4>
                            <p><strong>Tipo:</strong> ${property.chrType || 'N/A'}</p>
                            <p><strong>Transação:</strong> ${property.chrTransactionType === 'SALE' ? 'Venda' : 'Aluguel'}</p>
                            <p><strong>Valor:</strong> ${valueText}</p>
                            <p><strong>CEP:</strong> ${property.chrAddressPostalCode || 'N/A'}</p>
                            ${property.facilities && property.facilities.length > 0 ? 
                                `<p><strong>Facilidades:</strong> ${property.facilities.slice(0, 3).join(', ')}${property.facilities.length > 3 ? '...' : ''}</p>` : 
                                ''
                            }
                        </div>
                    `;

                    const marker = L.marker([lat, lng], { icon: icon })
                        .bindPopup(popupContent);
                    
                    // Adicionar propriedades customizadas para filtragem
                    marker.propertyData = {
                        transactionType: property.chrTransactionType,
                        type: property.chrType
                    };

                    allMarkers.push(marker);
                    markers.addLayer(marker);
                }
            });

            // Adicionar o grupo de marcadores ao mapa
            map.addLayer(markers);

            // Gráficos
            if (!apiStats.error) {
                // Gráfico de Transações
                const transactionLabels = Object.keys(apiStats.by_transaction);
                const transactionData = Object.values(apiStats.by_transaction);
                
                new Chart(document.getElementById('transactionChart'), {
                    type: 'pie',
                    data: {
                        labels: transactionLabels.map(t => t === 'SALE' ? 'Venda' : 'Aluguel'),
                        datasets: [{
                            data: transactionData,
                            backgroundColor: ['#28a745', '#007bff'],
                            borderColor: '#0e203e'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                // Gráfico de Tipos (Top 5)
                const typeEntries = Object.entries(apiStats.by_type)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                const typeLabels = typeEntries.map(entry => entry[0]);
                const typeData = typeEntries.map(entry => entry[1]);
                
                new Chart(document.getElementById('typeChart'), {
                    type: 'bar',
                    data: {
                        labels: typeLabels,
                        datasets: [{
                            label: 'Quantidade',
                            data: typeData,
                            backgroundColor: '#1e3a5f',
                            borderColor: '#f9a826',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Funcionalidade de filtros
            function applyFilters() {
                const transactionFilter = document.getElementById('transactionFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;

                // Limpar marcadores atuais
                markers.clearLayers();

                // Filtrar e adicionar marcadores
                allMarkers.forEach(function(marker) {
                    let showMarker = true;

                    if (transactionFilter && marker.propertyData.transactionType !== transactionFilter) {
                        showMarker = false;
                    }

                    if (typeFilter && marker.propertyData.type !== typeFilter) {
                        showMarker = false;
                    }

                    if (showMarker) {
                        markers.addLayer(marker);
                    }
                });
            }

            function clearFilters() {
                document.getElementById('transactionFilter').value = '';
                document.getElementById('typeFilter').value = '';
                
                // Mostrar todos os marcadores
                markers.clearLayers();
                allMarkers.forEach(function(marker) {
                    markers.addLayer(marker);
                });
            }

            // Event listeners para os filtros
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
        });
    </script>
</body>
</html>
